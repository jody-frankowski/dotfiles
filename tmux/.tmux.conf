### Colors
# /!\ If you change a color here you may have to change the ones used in window-status-current-format

# Copy-mode
setw -g copy-mode-current-match-style bg=green,fg=black
setw -g copy-mode-mark-style          bg=blue,fg=black
setw -g copy-mode-match-style         bg=blue,fg=black
setw -g mode-style                    bg=blue,fg=black # Top-right copy-mode indicator

# Menu
set -g menu-style          bg=black,fg=blue
set -g menu-selected-style bg=blue,fg=black

# Message (Bottom command line <prefix+:>)
set -g message-command-style fg=green
set -g message-style         fg=blue

# Panes
set  -g display-panes-active-colour green
set  -g display-panes-colour        blue
setw -g pane-active-border-style fg=blue
setw -g pane-border-style        fg=white

# Status line (status-left & status-right)
set -g status-style bg=black,fg=blue

# Windows
setw -g window-status-bell-style    bg=black,fg=red
setw -g window-status-current-style bg=green,fg=black
setw -g window-status-style         bg=black,fg=blue
###

# Global options
set -g bell-action any
set -g default-terminal "tmux-256color"
set -g escape-time 0
set -g focus-events on
set -g history-limit 100000
set -g mouse on
set -g status-justify centre
# Only update ssh related env variables and not DISPLAY/X11 env vars because
# this is a tmux session on a desktop.
set -g update-environment "SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CLIENT SSH_CONNECTION"

# Status line (command prompt/copy-mode search prompt) key-bindings style
set  -g status-keys emacs
# Copy-mode key-bindings style
setw -g mode-keys   vi

# Prefix key & copy-mode bindings
unbind C-b
set -g prefix C-Space
bind Space    send-prefix
unbind [
bind Space    copy-mode
bind C-Space  copy-mode

# Make selection in copy-mode copy the selection without exiting copy-mode immediately after
bind -T copy-mode    MouseDragEnd1Pane send-keys -X copy-pipe
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe

# Copy-mode bindings
unbind -T copy-mode    X
unbind -T copy-mode-vi X
bind -T copy-mode      m send -X set-mark
bind -T copy-mode-vi   m send -X set-mark

# Panes history bindings
bind C send -R \; clear-history
bind c clear-history

# Panes navigation bindings
bind h   select-pane -L
bind C-h select-pane -L
bind j   select-pane -D
bind C-j select-pane -D
bind k   select-pane -U
bind C-k select-pane -U
bind l   select-pane -R
bind C-l select-pane -R

# Panes resizing bindings
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Windows splitting bindings
# Split and cd into the same directory as the current pane.
# `pane_path` relies on the shell or the subprocess (e.g. NeoVim) to print OSC 7 ANSI escape
# sequences. See zsh/terminal.zsh for more informations.
bind   -  splitw -v -c "#{?pane_path,#{s|file.//.*//|/|:pane_path},#{pane_current_path}}"
bind   \\ splitw -h -c "#{?pane_path,#{s|file.//.*//|/|:pane_path},#{pane_current_path}}"
bind   |  splitw -h -c "#{?pane_path,#{s|file.//.*//|/|:pane_path},#{pane_current_path}}"
unbind \"
unbind \%

# Windows without prefix
bind -n              M-t new-window -a
bind -T copy-mode-vi M-t new-window -a
bind -n              M-T new-window -a -t'{end}'
bind -T copy-mode-vi M-T new-window -a -t'{end}'
bind -n              M-h previous-window
bind -T copy-mode-vi M-h previous-window
bind -n              M-l next-window
bind -T copy-mode-vi M-l next-window
bind -n              M-H swap-window -d -t -1
bind -T copy-mode-vi M-H swap-window -d -t -1
bind -n              M-L swap-window -d -t +1
bind -T copy-mode-vi M-L swap-window -d -t +1
bind -n              M-D kill-window
bind -T copy-mode-vi M-D kill-window
bind -n              M-s set synchronize-panes off
bind -T copy-mode-vi M-s set synchronize-panes off
bind -n              M-S set synchronize-panes on
bind -T copy-mode-vi M-S set synchronize-panes on

### Nested Tmux
# Empty spaces only for centering the windows
set -g status-right "    "

setenv -g nested_tmux 0

bind -T root M-k  \
  run-shell "tmux setenv nested_tmux $((#{nested_tmux} + 1))" \;\
  set status-right "  #{nested_tmux}â†‘" \;\
  set prefix None \;\
  set key-table off \;\
  if -F '#{pane_in_mode}' 'send -X cancel' \;\
  refresh-client -S

bind -T off M-j \
  if "[ #{nested_tmux} -eq 1 ]" \
        "run-shell '\
          tmux setenv nested_tmux 0 ; \
          tmux set status-right \"    \" ; \
          tmux set -u prefix ; \
          tmux set -u key-table ; \
          tmux refresh-client -S \
    '" \
        "run-shell '\
          tmux setenv nested_tmux $((#{nested_tmux} - 1)) ; \
          tmux send-key M-j ; \
          tmux refresh-client -S \
        '"

bind -T off M-k \
  run-shell "tmux setenv nested_tmux $((#{nested_tmux} + 1))" \;\
  send-key M-k \;\
  refresh-client -S

# Rescue keybinding in case we get stuck for some reason
bind -T off M-0 \
  setenv nested_tmux 0 \;\
  set status-right "    " \;\
  set -u prefix \;\
  set -u key-table \;\
  refresh-client -S
###

### Copy/Paste
unbind p
# Sync the desktop clipboard with tmux's paste buffer and then paste it
bind p run   "clipboard --paste | tmux load-buffer - ; tmux paste-buffer -r"
bind C-p run "clipboard --paste | tmux load-buffer - ; tmux paste-buffer -r"

# Start selection in copy-mode
bind -T copy-mode-vi v send -X begin-selection
# AFAICT copy-pipe both copies the selection in the paste buffer and pipes it to an external command
bind -T copy-mode-vi y send -X copy-pipe "clipboard"
###

# Make tmux resize only the displayed windows to smaller clients
setw -g aggressive-resize on

### Titles and Names
# Renumber windows from 0 whenever one is closed. Even if the number isn't shown in the title, we
# need it to have the first window number always being equal to 0 (see window-status-*format).
set -g renumber-windows on

# Remove the default status' windows separator ` `
setw -g window-status-separator ""

# Set the current window format
# #window_name isn't updated when the pane is switched, so we use #pane_title instead.
# 1. Pane title
# 2. Window flags without the current window indicator `*` and with the zoom flag `Z` replaced by `+`
setw -g window-status-current-format \
" #{pane_title} \
#{?#{s/\\*//:window_flags},#{s/Z/+:#{s/\\*//:window_flags}} ,}"

# Set the other windows format
# 1. Pane title
# 2. Window flags without the last window indicator `-` and with the zoom flag `Z` replaced by `+`
# 3. `|` separator, only if isn't the last window or the next one isn't the active one
# Note: #I == window_index
setw -g window-status-format \
"#{?#{||:#{window_start_flag},#{==:#{e|-:#I,1},#{active_window_index}}},,|}\
 #{pane_title} \
#{?#{s/-//:window_flags},#{s/Z/+:#{s/-//:window_flags}} ,}"

# The following *standard* escape sequences will change #T:
# '\e]0;TITLE\a' or '\e]2;TITLE\a'

# Because we don't use #W, we don't need to set 'allow-rename' to
# 'on'. This would have let #W be modified by the following non
# standard espace sequence: '\ekTITLE\e\\'

# Finally we let tmux change the outer terminal title
set -g set-titles on
set -g set-titles-string "#{user}@#h #T#{?session_alerts, session_alerts,}"

# More information about Windows/Panes title/name can be found here:
# https://github.com/tmux/tmux/issues/1342
###

# Source `.tmux.conf` file - as suggested in `man tmux`
bind R run-shell ' \
  tmux source-file ~/.tmux.conf > /dev/null; \
  tmux display-message "Sourced .tmux.conf!"'

source-file -q ~/.tmux/*.tmux

# Plugins
# Supports `github_username/repo` or full git repo URLs
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-copycat'

set -g @plugin tmux-plugins/tmux-resurrect
set -g @resurrect-capture-pane-contents on
set -g @resurrect-dir ~/.tmux/resurrect # Default is ~/.local/share/tmux/resurrect
set -g @resurrect-processes 'emacsclient fzf journalctl mosh-client'
set -g @resurrect-processes '"nvim->v *"'

set -g @plugin tmux-plugins/tmux-continuum
set -g @continuum-restore on
set -g @continuum-save-interval 15

# Inits tpm. Keep at bottom.
run-shell ~/.tmux/plugins/tpm/tpm
